<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Bubble Pop Game - A fun web-based game with progressive difficulty and sound effects">
    <meta name="keywords" content="bubble game, web game, javascript game, popping bubbles, mobile game">
    <meta name="author" content="Bubble Game Developer">
    
    <!-- Mobile app meta tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bubble Pop">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="msapplication-TileColor" content="#1a1a2e">
    
    <title>Bubble Pop Game - Progressive Bubble Popping Fun</title>
    
    <!-- Favicon and app icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%2387CEEB' stroke='%23fff' stroke-width='2'/></svg>">
    
    <!-- Cache control for immediate updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="css/styles.css?v=2.16" as="style">
    <link rel="preload" href="js/gamestate.js?v=2.16" as="script">
    <link rel="preload" href="js/bubble.js?v=2.16" as="script">
    <link rel="preload" href="js/audio.js?v=2.16" as="script">
    <link rel="preload" href="js/game.js?v=2.16" as="script">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/styles.css?v=2.16">
    
    <!-- Open Graph meta tags for social sharing -->
    <meta property="og:title" content="Bubble Pop Game">
    <meta property="og:description" content="A fun web-based bubble popping game with progressive difficulty">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    
    <!-- Twitter Card meta tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Bubble Pop Game">
    <meta name="twitter:description" content="A fun web-based bubble popping game">
</head>
<body>
    <!-- Audio Setup Screen -->
    <div id="audioSetupScreen" class="setup-screen" style="display: block;">
        <div class="setup-content">
            <h1 style="color: #FFD700; margin-bottom: 20px;">🎮 Bubble Pop Game</h1>
            <p style="font-size: 18px; margin-bottom: 20px;">Get ready to pop bubbles and learn letters!</p>
            
            <div class="setup-info" style="background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h2 style="color: #87CEEB; margin-bottom: 15px;">🎵 Audio Setup Required</h2>
                <p style="margin-bottom: 10px;">This game uses audio to announce letters when you pop bubbles.</p>
                <p style="margin-bottom: 10px;"><strong>Tap the button below to enable audio and start playing!</strong></p>
                <p style="font-size: 14px; opacity: 0.8;">Extra slow, crystal-clear letter pronunciation perfect for young learners!</p>
            </div>
            
            <button id="enableAudioButton" class="setup-button" style="
                background: linear-gradient(45deg, #4CAF50, #45a049);
                color: white;
                border: none;
                padding: 15px 30px;
                font-size: 18px;
                border-radius: 25px;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                transition: all 0.3s ease;
                margin-bottom: 20px;
            ">
                🔊 Enable Audio & Start Game
            </button>
            
            <div id="audioTestStatus" style="display: none; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                <p id="testMessage">Testing audio...</p>
                <div id="testProgress" style="background: #333; height: 6px; border-radius: 3px; margin-top: 10px;">
                    <div id="progressBar" style="background: #4CAF50; height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s ease;"></div>
                </div>
            </div>
            
            <p style="font-size: 12px; opacity: 0.7; margin-top: 20px;">
                v2.16 - Extra Slow Crystal Clear Speech
            </p>
        </div>
    </div>

    <!-- Main game container -->
    <div class="game-container" id="gameContainer" style="display: none;">
        <!-- Version indicator -->
        <div style="text-align: center; margin-bottom: 10px; color: #FFD700; font-weight: bold; background: rgba(0,0,0,0.3); border-radius: 15px; padding: 5px 10px; font-size: 14px;">
            🎮 Bubble Game v2.16 - Extra Slow Speech for Crystal Clear Letters
        </div>

        <!-- Game header with score, timer, and level display -->
        <header class="game-header" role="banner">
            <div class="score-display" aria-label="Current Score">
                Score: <span id="score" aria-live="polite">0</span>
            </div>
            <div class="timer-display" aria-label="Time Remaining">
                Time: <span id="timer" aria-live="polite">30</span>s
            </div>
            <div class="level-display" aria-label="Current Level and Target">
                Level: <span id="level" aria-live="polite">1</span> 
                (Target: <span id="target" aria-live="polite">5</span>)
            </div>
        </header>
        
        <!-- Main game canvas -->
        <main role="main">
            <canvas 
                id="gameCanvas" 
                aria-label="Game canvas - click on bubbles to pop them"
                role="img"
                touch-action="manipulation">
                Your browser does not support the HTML5 Canvas element required for this game.
                Please update your browser or try a different one.
            </canvas>
        </main>
        
        <!-- Game control buttons -->
        <section class="game-controls" role="region" aria-label="Game Controls">
            <button 
                id="startButton" 
                class="start-button" 
                type="button"
                aria-label="Start new game">
                Start Game
            </button>
            <button 
                id="restartButton" 
                class="restart-button" 
                type="button"
                style="display: none;"
                aria-label="Restart current game">
                Restart Game
            </button>
        </section>
        
        <!-- Game information and instructions -->
        <section class="game-info" role="region" aria-label="Game Instructions">
            <h2 style="margin-bottom: 10px; font-size: 18px; color: #FFD700;">How to Play</h2>
            <p><strong>Objective:</strong> Click on bubbles to pop them before they fall off the screen!</p>
            <p><strong>Letters:</strong> Each bubble shows a letter A-Z that will be announced when popped!</p>
            <p><strong>Scoring:</strong> Regular bubbles = 1 point | <strong style="color: #FFD700;">Gold bubbles = 5 points</strong></p>
            <p><strong>Level Up:</strong> Reach the target score to advance to the next level with faster bubbles!</p>
            <p><strong>Controls:</strong> 
                <kbd>Click</kbd> = Pop bubbles | 
                <kbd>Space</kbd> = Start game | 
                <kbd>Ctrl+R</kbd> = Restart | 
                <kbd>M</kbd> = Toggle sound
            </p>
        </section>
        
        <!-- Accessibility information -->
        <section class="accessibility-info" style="font-size: 12px; opacity: 0.7; margin-top: 10px; text-align: center;">
            <p>This game requires mouse/touch input and includes sound effects and speech synthesis. 
            Visual indicators show score and progress. Letters are announced when bubbles are popped.</p>
            <p style="font-size: 10px; margin-top: 5px; color: #FFD700;">
                🎵 v2.16 - Extra Slow Speech: 0.5x speed for crystal-clear letter pronunciation perfect for 3-year-olds • 
                <span id="refresh-hint" style="cursor: pointer;" onclick="location.reload(true)">
                    Click here to refresh if needed
                </span>
            </p>
        </section>
    </div>
    
    <!-- Loading indicator (hidden by default) -->
    <div id="loadingIndicator" class="loading-indicator" style="display: none;" aria-hidden="true">
        <div>Loading game...</div>
    </div>
    
    <!-- Error message container -->
    <div id="errorContainer" class="error-container" style="display: none;" role="alert" aria-live="assertive">
        <div id="errorMessage"></div>
        <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 15px;">Reload Game</button>
    </div>
    
    <!-- No-script fallback -->
    <noscript>
        <div style="text-align: center; padding: 50px; color: white; background: rgba(255, 0, 0, 0.8); margin: 20px; border-radius: 10px;">
            <h2>JavaScript Required</h2>
            <p>This game requires JavaScript to be enabled in your browser.</p>
            <p>Please enable JavaScript and refresh the page to play.</p>
        </div>
    </noscript>
    
    <!-- JavaScript files - loaded in dependency order with cache busting -->
    <script src="js/gamestate.js?v=2.16" defer></script>
    <script src="js/bubble.js?v=2.16" defer></script>
    <script src="js/audio.js?v=2.16" defer></script>
    <script src="js/game.js?v=2.16" defer></script>
    
    <!-- Audio Setup Handler -->
    <script>
        // Audio setup functionality
        window.audioSetupHandler = {
            async setupAudio() {
                const button = document.getElementById('enableAudioButton');
                const statusDiv = document.getElementById('audioTestStatus');
                const messageEl = document.getElementById('testMessage');
                const progressBar = document.getElementById('progressBar');
                
                // Show loading state
                button.disabled = true;
                button.innerHTML = '🔄 Setting up audio...';
                statusDiv.style.display = 'block';
                
                try {
                    // Test speech synthesis with user interaction
                    await this.testSpeechSynthesis(messageEl, progressBar);
                    
                    // If successful, hide setup screen and show game
                    setTimeout(() => {
                        document.getElementById('audioSetupScreen').style.display = 'none';
                        document.getElementById('gameContainer').style.display = 'block';
                        
                        // Initialize game if AudioManager is available
                        if (window.audioManager) {
                            window.audioManager.initialized = true;
                            console.log('✅ Audio setup complete, game ready to start');
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Audio setup failed:', error);
                    messageEl.textContent = 'Audio setup failed, but you can still play!';
                    button.innerHTML = '⚠️ Continue Without Audio';
                    button.onclick = () => {
                        document.getElementById('audioSetupScreen').style.display = 'none';
                        document.getElementById('gameContainer').style.display = 'block';
                    };
                    button.disabled = false;
                }
            },
            
            async testSpeechSynthesis(messageEl, progressBar) {
                return new Promise((resolve, reject) => {
                    try {
                        messageEl.textContent = 'Testing speech synthesis...';
                        progressBar.style.width = '20%';
                        
                        // Wait for voices to load
                        const waitForVoices = () => {
                            const voices = speechSynthesis.getVoices();
                            if (voices.length > 0) {
                                this.testVoicePlayback(messageEl, progressBar, resolve, reject);
                            } else {
                                setTimeout(waitForVoices, 100);
                            }
                        };
                        
                        // Check if voices are already loaded
                        const voices = speechSynthesis.getVoices();
                        if (voices.length > 0) {
                            this.testVoicePlayback(messageEl, progressBar, resolve, reject);
                        } else {
                            // Wait for voices to load
                            speechSynthesis.addEventListener('voiceschanged', waitForVoices, { once: true });
                            setTimeout(waitForVoices, 500); // Fallback timeout
                        }
                        
                    } catch (error) {
                        reject(error);
                    }
                });
            },
            
            testVoicePlayback(messageEl, progressBar, resolve, reject) {
                try {
                    messageEl.textContent = 'Testing letter pronunciation...';
                    progressBar.style.width = '60%';
                    
                    // Create test utterance
                    const testText = 'a'; // Test with lowercase "a" to avoid "capital" prefix
                    const utterance = new SpeechSynthesisUtterance(testText);
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    // Find good voice
                    const voices = speechSynthesis.getVoices();
                    const preferredVoice = voices.find(v => v.lang.startsWith('en') && v.localService) || 
                                         voices.find(v => v.lang.startsWith('en')) || 
                                         voices[0];
                    
                    if (preferredVoice) {
                        utterance.voice = preferredVoice;
                        console.log(`Testing with voice: ${preferredVoice.name}`);
                    }
                    
                    utterance.onend = () => {
                        messageEl.textContent = '✅ Audio setup successful!';
                        progressBar.style.width = '100%';
                        console.log('✅ Speech synthesis test successful');
                        resolve();
                    };
                    
                    utterance.onerror = (event) => {
                        console.warn('Speech test error:', event.error);
                        messageEl.textContent = '⚠️ Audio may not work perfectly';
                        progressBar.style.width = '100%';
                        resolve(); // Continue anyway
                    };
                    
                    // Cancel any ongoing speech and speak test
                    speechSynthesis.cancel();
                    setTimeout(() => {
                        speechSynthesis.speak(utterance);
                    }, 100);
                    
                    // Timeout fallback
                    setTimeout(() => {
                        if (!utterance.onend.called) {
                            console.log('Speech test timed out, but continuing');
                            messageEl.textContent = '⚠️ Audio test timed out, continuing...';
                            progressBar.style.width = '100%';
                            resolve();
                        }
                    }, 3000);
                    
                } catch (error) {
                    reject(error);
                }
            }
        };
        
        // Set up event listener when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            const enableButton = document.getElementById('enableAudioButton');
            if (enableButton) {
                enableButton.addEventListener('click', () => {
                    window.audioSetupHandler.setupAudio();
                });
            }
        });
    </script>

    <!-- Analytics and error tracking (placeholder) -->
    <script>
        // Global error handler for debugging
        window.addEventListener('error', function(event) {
            console.error('Global error caught:', event.error);
            
            // Show user-friendly error message
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorContainer && errorMessage) {
                errorMessage.textContent = 'An error occurred. Please try refreshing the page.';
                errorContainer.style.display = 'block';
            }
        });
        
        // Performance monitoring
        window.addEventListener('load', function() {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`Page load time: ${loadTime}ms`);
            }
        });
        
        // Basic analytics tracking (placeholder)
        function trackEvent(action, category, label) {
            console.log(`Analytics: ${category} - ${action} - ${label}`);
            // Could integrate with Google Analytics, etc.
        }
        
        // Make analytics available globally
        window.trackEvent = trackEvent;
    </script>
</body>
</html>
